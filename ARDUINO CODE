#define x A1 // Arduino pin connected to the VRx Pin


#define y A2 // Arduino pin connected to the VRy Pin

//#define SW_pin 8 // Arduino pin connected to the SW Pin

#define m1 3
#define m2 5
#define m3 6
#define m4 9

#define ir A0
#define Alert 4
#define buzzer A4

#define sit A5

char value = 0;

int cnt = 0;
int time = 10;
int Speed = 250;
int buzzerflag = 0;
int alrtflag = 0;
int alrtbuzzflag = 0;
int sitflag = 0;


unsigned long startMillis;  //some global variables available anywhere in the program
unsigned long currentMillis;

unsigned long startMillis2;  //some global variables available anywhere in the program
unsigned long currentMillis2;

unsigned long startMillis3;  //some global variables available anywhere in the program
unsigned long currentMillis3;


const unsigned long period = 5000;  //the value is a number of milliseconds

void setup() {

    pinMode(ir, INPUT);
    pinMode(Alert, INPUT_PULLUP);
    pinMode(x, INPUT);
    pinMode(y, INPUT);

    // pinMode(sit, INPUT_PULLUP);
   

   pinMode(m1, OUTPUT);
  pinMode(m2, OUTPUT);
  pinMode(m3, OUTPUT);
  pinMode(m4, OUTPUT);
  pinMode(buzzer, OUTPUT);
//  digitalWrite(buzzer,LOW);
  //Start the serial communication

// pinMode(SW_pin, INPUT_PULLUP);

 startMillis = millis();  //initial start time
 startMillis2 = millis();  //initial start time
 startMillis3 = millis();

 
 
  Serial.begin(9600);
  //Set the motor speeds
//  M1.setSpeed(Speed);
//  M2.setSpeed(Speed);
//  M3.setSpeed(Speed);
//  M4.setSpeed(Speed);
}

void loop() {

  int X = analogRead(x);
  int Y = analogRead(y);

//    Serial.print(X);
//    Serial.print("\t");
//    Serial.println(Y);
//  delay(100);

if (digitalRead(sit) == HIGH && sitflag == 0)
   {

    currentMillis = millis();  //get the current "time" (actually the number of milliseconds since the program started)
  if (currentMillis - startMillis >= period)  //test whether the period has elapsed
  {

    Serial.println("122");
    delay(111);
    sitflag = 1;
    startMillis = currentMillis;  //IMPORTANT to save the start time of the current LED state.
   
   
  }
     
  }

 

  else if (digitalRead(sit) == LOW) //necessary to use else if otherwise simple else will cause issue
  {
    startMillis = millis(); // resetting timer
    startMillis2 = millis(); // resetting timer
    sitflag = 0;   //reseting flag
    buzzerflag = 0;
  }

//   Serial.println("S" + String(sitflag));
//   Serial.println("B" + String(buzzerflag));

  if( sitflag == 1 && buzzerflag == 0)
  {
    digitalWrite(buzzer,HIGH);
    currentMillis2 = millis();  //get the current "time" (actually the number of milliseconds since the program started)
  if (currentMillis2 - startMillis2 >= period)  //test whether the period has elapsed
  {

    digitalWrite(buzzer,LOW);
    startMillis2 = currentMillis2;  //IMPORTANT to save the start time of the current LED state.
    buzzerflag = 1;
  }

  }

  else if (sitflag == 0 && buzzerflag == 0)
 
  {
    startMillis2 = millis();   // geting latest start time for buzzer otherwise issue
  }

 
///////////////////////////////////////////////

 
///////////////////////////////////////////////

  if (digitalRead(Alert) == LOW && alrtflag == 0 && alrtbuzzflag == 0)
  {
   Serial.println("122");
    alrtflag = 1;
    alrtbuzzflag = 1;

  }

  else if (digitalRead(Alert) == HIGH && alrtbuzzflag == 0 )
  {
    startMillis3 = millis();   // geting latest start time for buzzer otherwise issue
     alrtflag = 0;
//     alrtbuzzflag = 0;
  }

  if  ( alrtbuzzflag == 1)
  {
    digitalWrite(buzzer,HIGH);
    currentMillis3 = millis();  //get the current "time" (actually the number of milliseconds since the program started)
  if (currentMillis3 - startMillis3 >= period)  //test whether the period has elapsed
  {

    digitalWrite(buzzer,LOW);
    startMillis3 = currentMillis3;  //IMPORTANT to save the start time of the current LED state.
    alrtbuzzflag = 0;
  }

  }

//   else if (alrtflag == 0 && alrtbuzzflag == 0) // compulsory otherwise buzzer issue
//  {
//    startMillis3 = millis();   // geting latest start time for buzzer otherwise issue
//  }

 
//Serial.println("AF" + String(alrtflag));
//   Serial.println("ABF" + String(alrtbuzzflag));


 
//  if (digitalRead(SW_pin) == LOW ) //horn
//  {
//    digitalWrite(buzzer,HIGH);
//  }
//
//  else if (digitalRead(SW_pin) == HIGH && alrtflag == 0 && alrtbuzzflag == 0 )
//  {
//    digitalWrite(buzzer,LOW);
//  }



  if (X < 800 && analogRead(ir) >= 666 && digitalRead(sit) == LOW ) {
    forward();
//        Serial.println("forward");
  }
  else if (X < 800 && Y <100 && digitalRead(sit) == LOW ) {
     right();
//      Serial.println("right");
  }
  else if (Y >= 100 && digitalRead(sit) == LOW) {
     left();
//          Serial.println(" left");
  }
  else if (X > 900 && digitalRead(sit) == LOW) {
  backward();  //left(); right(); Y <= 500
//        Serial.println("backward");
  }
  else if( (X > 1000 && X < 600 && value == '0' || value == 0) ){
    Stop();
  }

  //For Stopping Motor But Moving in any other direction

  if (analogRead(ir) < 666 && (value == '1' || value == 'b' )) {
      Stop();
    }
  if (analogRead(ir) < 666 )
     {
      digitalWrite(buzzer,HIGH);
    }
    else if (analogRead(ir) > 666 )
     {
      digitalWrite(buzzer,LOW);
    }
   
  // if (analogRead(ir) < 666 || value == '0') {
  //     Stop();
  //   }
 
//  if (btnpress == 10)
//  {
//      buzzertime();
//  }

  bluetoothControl();//Bluetooth control function


}


void bluetoothControl() {
  //Get the Bluetooth control remote values
  if (Serial.available() > 0) {
     value = Serial.read();
//     Serial.println(value);
//delay(555);rightforward(); backwardleft
    if ((value == '1' || value == 'b') && analogRead(ir) >= 666  && digitalRead(sit) == LOW) {
     forward();
    } else if ((value == '2' || value == 'd' ) && digitalRead(sit) == LOW ) {
      backward();
    } else if ((value == '3' ) && digitalRead(sit) == LOW) {
      left();
    } else if ((value == '4') && digitalRead(sit) == LOW) {
     right();
    } else if (value == '0') {
      Stop();
    }
 
  }

  //  if (value == 'a') {
  //    forward();

  //    }

  if (value == 'a' && digitalRead(sit) == LOW ) {
      forward();
     cnt = cnt + 1;
//    Serial.println(cnt);right
     delay(10);
     if (cnt == time)
     {
        Stop();
       value = 0;
       cnt = 0;
     }
  }

   if (value == 'c' && digitalRead(sit) == LOW) {
     backward();
     cnt = cnt + 1;
//    Serial.println(cnt); backward();left
     delay(10);
     if (cnt == time)
     {
      
       value = 0;
       cnt = 0;
     }
  }


 if (value == 'e' && digitalRead(sit) == LOW) {
      left();
     cnt = cnt + 1;
//    Serial.println(cnt);backward
     delay(10);
     if (cnt == time)
     {
       Stop();
       value = 0;
       cnt = 0;
     }
  }


   if (value == 'f' && digitalRead(sit) == LOW) {
    right();
     cnt = cnt + 1;
//    Serial.println(cnt); forward();
     delay(10);
     if (cnt == time)
    {
       value = 10;
       cnt = 0;
     }
  }


}

//*Motor functions/
void forward() {
//  M1.run(FORWARD);
//  M2.run(FORWARD);
//  M3.run(FORWARD);
//  M4.run(FORWARD);

    //forward
      analogWrite(m1,Speed);
      analogWrite(m2,0);
      analogWrite(m3,Speed);
      analogWrite(m4,0);

      // digitalWrite(m1, HIGH);
      // digitalWrite(m2, LOW);
      // digitalWrite(m3, HIGH);
      // digitalWrite(m4, LOW);



//      Serial.println("Going forward!");
}
void backward() {
//  M1.run(BACKWARD);
//  M2.run(BACKWARD);
//  M3.run(BACKWARD);
//  M4.run(BACKWARD);

    //backward

      analogWrite(m1,0);
      analogWrite(m2,Speed);
      analogWrite(m3,0);
      analogWrite(m4,Speed);

      // digitalWrite(m1, LOW);
      // digitalWrite(m2, HIGH);
      // digitalWrite(m3, LOW);
      // digitalWrite(m4, HIGH);
//      Serial.println("Going backward!");
}
void left() {
//  M1.run(FORWARD);
//  M2.run(BACKWARD);
//  M3.run(BACKWARD);
//  M4.run(FORWARD);

    //right

      analogWrite(m1,Speed);
      analogWrite(m2,Speed);
      analogWrite(m3,0);
      analogWrite(m4,Speed);

      // digitalWrite(m1, HIGH);
      // digitalWrite(m2, LOW);
      // digitalWrite(m3, LOW);
      // digitalWrite(m4, HIGH);
//      Serial.println("Going right!");
}
void right() {
//  M1.run(BACKWARD);
//  M2.run(FORWARD);
//  M3.run(FORWARD);
//  M4.run(BACKWARD);

    //left
      analogWrite(m1,0);
      analogWrite(m2,Speed);
      analogWrite(m3,0);
      analogWrite(m4,0);

      // digitalWrite(m1, LOW);
      // digitalWrite(m2, HIGH);
      // digitalWrite(m3, HIGH);
      // digitalWrite(m4, LOW);
//      Serial.println("Going left!");
}
void Stop() {
//  M1.run(RELEASE);
//  M2.run(RELEASE);
//  M3.run(RELEASE);
//  M4.run(RELEASE);

    //all off

      analogWrite(m1,0);
      analogWrite(m2,0);
       analogWrite(m3,0);
  analogWrite(m4,Speed);

      // digitalWrite(m1, LOW);
      // digitalWrite(m2, LOW);
      // digitalWrite(m3, HIGH);
      // digitalWrite(m4, LOW);
}
